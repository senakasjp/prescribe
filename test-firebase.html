<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Integration Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-fire me-2"></i>Firebase Integration Test</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            This page helps you test the Firebase integration step by step.
                        </div>

                        <!-- Test Results -->
                        <div id="testResults" class="mb-4">
                            <h5>Test Results:</h5>
                            <div id="results"></div>
                        </div>

                        <!-- Test Buttons -->
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="testEnvironment()">
                                <i class="fas fa-cog me-2"></i>Test Environment Configuration
                            </button>
                            <button class="btn btn-success" onclick="testFirebaseConnection()">
                                <i class="fas fa-fire me-2"></i>Test Firebase Connection
                            </button>
                            <button class="btn btn-warning" onclick="testAuthentication()">
                                <i class="fas fa-user-lock me-2"></i>Test Authentication
                            </button>
                            <button class="btn btn-info" onclick="testDatabase()">
                                <i class="fas fa-database me-2"></i>Test Database Operations
                            </button>
                            <button class="btn btn-secondary" onclick="testMigration()">
                                <i class="fas fa-exchange-alt me-2"></i>Test Data Migration
                            </button>
                            <button class="btn btn-dark" onclick="runAllTests()">
                                <i class="fas fa-play me-2"></i>Run All Tests
                            </button>
                        </div>

                        <!-- Console Output -->
                        <div class="mt-4">
                            <h5>Console Output:</h5>
                            <div id="console" class="bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Capture console output
        const originalLog = console.log;
        const originalError = console.error;
        const consoleDiv = document.getElementById('console');
        
        function addToConsole(message, type = 'log') {
            const div = document.createElement('div');
            div.className = type === 'error' ? 'text-danger' : 'text-light';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleDiv.appendChild(div);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        // Test functions
        window.testEnvironment = async function() {
            addResult('Testing Environment Configuration...', 'info');
            
            try {
                const config = {
                    apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
                    projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
                    useFirebase: import.meta.env.VITE_USE_FIREBASE
                };
                
                console.log('Environment config:', config);
                
                if (config.apiKey && config.apiKey !== 'your-api-key-here') {
                    addResult('✅ Environment configuration loaded correctly', 'success');
                } else {
                    addResult('❌ Environment configuration missing or using defaults', 'danger');
                }
            } catch (error) {
                addResult('❌ Error testing environment: ' + error.message, 'danger');
                console.error('Environment test error:', error);
            }
        };

        window.testFirebaseConnection = async function() {
            addResult('Testing Firebase Connection...', 'info');
            
            try {
                const { auth, db } = await import('./src/firebase-config.js');
                
                console.log('Firebase Auth:', !!auth);
                console.log('Firebase DB:', !!db);
                
                if (auth && db) {
                    addResult('✅ Firebase connection successful', 'success');
                } else {
                    addResult('❌ Firebase connection failed', 'danger');
                }
            } catch (error) {
                addResult('❌ Error testing Firebase connection: ' + error.message, 'danger');
                console.error('Firebase connection test error:', error);
            }
        };

        window.testAuthentication = async function() {
            addResult('Testing Firebase Authentication...', 'info');
            
            try {
                const firebaseAuthService = await import('./src/services/firebaseAuth.js');
                const authService = firebaseAuthService.default;
                
                console.log('Firebase Auth Service loaded:', !!authService);
                
                // Test sign up
                const testEmail = 'test@example.com';
                const testPassword = 'password123';
                
                try {
                    const result = await authService.createDoctor(testEmail, testPassword, {
                        firstName: 'Test',
                        lastName: 'Doctor'
                    });
                    
                    if (result.success) {
                        addResult('✅ Authentication test successful - Doctor created', 'success');
                    } else {
                        addResult('❌ Authentication test failed: ' + result.error, 'danger');
                    }
                } catch (error) {
                    if (error.message.includes('already exists')) {
                        addResult('✅ Authentication test successful - Doctor already exists', 'success');
                    } else {
                        addResult('❌ Authentication test failed: ' + error.message, 'danger');
                    }
                }
            } catch (error) {
                addResult('❌ Error testing authentication: ' + error.message, 'danger');
                console.error('Authentication test error:', error);
            }
        };

        window.testDatabase = async function() {
            addResult('Testing Database Operations...', 'info');
            
            try {
                const firebaseStorageService = await import('./src/services/firebaseStorage.js');
                const storageService = firebaseStorageService.default;
                
                console.log('Firebase Storage Service loaded:', !!storageService);
                
                // Test creating a patient
                const patientData = {
                    firstName: 'Test',
                    lastName: 'Patient',
                    email: 'patient@example.com',
                    idNumber: '123456789',
                    doctorId: 'test-doctor-id'
                };
                
                try {
                    const patient = await storageService.createPatient(patientData);
                    console.log('Patient created:', patient);
                    addResult('✅ Database operations test successful', 'success');
                } catch (error) {
                    addResult('❌ Database operations test failed: ' + error.message, 'danger');
                }
            } catch (error) {
                addResult('❌ Error testing database: ' + error.message, 'danger');
                console.error('Database test error:', error);
            }
        };

        window.testMigration = async function() {
            addResult('Testing Data Migration...', 'info');
            
            try {
                const dataMigrationService = await import('./src/services/dataMigration.js');
                const migrationService = dataMigrationService.default;
                
                console.log('Data Migration Service loaded:', !!migrationService);
                
                const needsMigration = await migrationService.needsMigration();
                console.log('Needs migration:', needsMigration);
                
                if (needsMigration) {
                    addResult('ℹ️ Migration needed - localStorage has data to migrate', 'info');
                } else {
                    addResult('ℹ️ No migration needed - Firebase already has data or localStorage is empty', 'info');
                }
            } catch (error) {
                addResult('❌ Error testing migration: ' + error.message, 'danger');
                console.error('Migration test error:', error);
            }
        };

        window.runAllTests = async function() {
            addResult('Running all tests...', 'info');
            
            await testEnvironment();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testFirebaseConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testAuthentication();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testDatabase();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testMigration();
            
            addResult('All tests completed!', 'success');
        };

        function addResult(message, type) {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `alert alert-${type} alert-dismissible fade show`;
            div.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            resultsDiv.appendChild(div);
        }

        // Auto-run environment test on load
        window.addEventListener('load', () => {
            addResult('Firebase Integration Test Page Loaded', 'info');
            console.log('Test page loaded. Click buttons to run tests.');
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
